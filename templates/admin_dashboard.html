<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      .top-menu { 
        margin-bottom: 20px; 
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }
      .top-menu a { 
        display: inline-block; 
        padding: 8px 18px; 
        background: #007bff; 
        color: #fff; 
        border-radius: 5px; 
        text-decoration: none; 
        font-weight: bold; 
      }
      .top-menu a:hover { background: #0056b3; }
      
      .ai-menu {
        margin-bottom: 20px;
        padding: 15px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 10px;
      }
      .ai-menu h3 {
        color: white;
        margin-bottom: 15px;
        text-align: center;
      }
      .ai-menu .ai-links {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
      }
      .ai-menu a {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        padding: 10px 20px;
        border-radius: 25px;
        text-decoration: none;
        font-weight: bold;
        transition: all 0.3s ease;
      }
      .ai-menu a:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
      }
      
      @media (max-width: 768px) {
        .top-menu, .ai-menu .ai-links {
          flex-direction: column;
        }
        .top-menu a, .ai-menu a {
          text-align: center;
        }
      }
    </style>
</head>
<body>
    <div class="container">
        <div class="top-menu">
          <a href="/admin/students">í•™ìƒ ê´€ë¦¬</a>
          <a href="/admin/class_stats">ë°˜ë³„ í†µê³„</a>
          <a href="/create_exam" style="background:#28a745;">ì‹œí—˜ ìƒì„±</a>
          <a href="/upload_exam" style="background:#ffc107; color:#222;">ì‹œí—˜ ì—…ë¡œë“œ</a>
        </div>
        
        <div class="ai-menu">
          <h3>ğŸ¤– AI ê¸°ëŠ¥</h3>
          <div class="ai-links">
            <a href="/chatgpt/chat">ğŸ’¬ ChatGPT ì±„íŒ…</a>
            <a href="/chatgpt/generate_questions">ğŸ“ AI ë¬¸ì œ ìƒì„±</a>
            <a href="/chatgpt/analyze_results">ğŸ“Š AI ê²°ê³¼ ë¶„ì„</a>
          </div>
        </div>
        
        <h2>ğŸ“š ì‹œí—˜ ëª©ë¡</h2>
        <div class="exam-list">
          {% if exams %}
            <form method="POST" action="{{ url_for('delete_exams_bulk') }}" id="bulkDeleteForm">
              <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <button type="button" onclick="toggleAllCheckboxes()" 
                        style="background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 14px;">
                  ì „ì²´ ì„ íƒ/í•´ì œ
                </button>
                <button type="submit" onclick="return confirmBulkDelete()" 
                        style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 14px;">
                  ì„ íƒëœ ì‹œí—˜ ì‚­ì œ
                </button>
                <span id="selectedCount" style="color: #666; font-size: 14px;">ì„ íƒëœ ì‹œí—˜: 0ê°œ</span>
              </div>
              
              <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
                <thead>
                  <tr style="background: #f8f9fa;">
                    <th style="padding: 12px; border: 1px solid #ddd; text-align: center; width: 50px;">
                      <input type="checkbox" id="selectAll" onchange="toggleAllCheckboxes()">
                    </th>
                    <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">ì‹œí—˜ëª…</th>
                    <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">ë¬¸í•­ ìˆ˜</th>
                    <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">ì‘ì‹œì ìˆ˜</th>
                    <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">í‰ê·  ì ìˆ˜</th>
                    <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">ì‘ì—…</th>
                  </tr>
                </thead>
                <tbody>
                  {% for exam in exams %}
                    <tr style="border-bottom: 1px solid #ddd;">
                      <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">
                        <input type="checkbox" name="exam_ids" value="{{ exam.id }}" class="exam-checkbox" onchange="updateSelectedCount()">
                      </td>
                      <td style="padding: 12px; border: 1px solid #ddd;">
                        <strong>{{ exam.title }}</strong>
                        {% if exam.category %}
                          <br><small style="color: #666;">{{ exam.category }}</small>
                        {% endif %}
                      </td>
                      <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">
                        {{ exam.questions|length if exam.questions else 0 }}ê°œ
                      </td>
                      <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">
                        {{ exam.results|length if exam.results else 0 }}ëª…
                      </td>
                      <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">
                        {% if exam.results %}
                          {% set scores = exam.results|map(attribute='score')|list %}
                          {{ "%.1f"|format(scores|sum / scores|length) }}ì 
                        {% else %}
                          -
                        {% endif %}
                      </td>
                      <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">
                        <div style="display: flex; gap: 5px; justify-content: center; flex-wrap: wrap;">
                          <a href="{{ url_for('edit_exam', exam_id=exam.id) }}" 
                             style="background: #007bff; color: white; padding: 5px 10px; border-radius: 3px; text-decoration: none; font-size: 12px;">
                            í¸ì§‘
                          </a>
                          <a href="{{ url_for('analyze_results') }}?exam_id={{ exam.id }}" 
                             style="background: #28a745; color: white; padding: 5px 10px; border-radius: 3px; text-decoration: none; font-size: 12px;">
                            ë¶„ì„
                          </a>
                          <form method="POST" action="{{ url_for('delete_exam', exam_id=exam.id) }}" 
                                style="display: inline;" 
                                onsubmit="return confirm('ì •ë§ë¡œ ì´ ì‹œí—˜ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì£¼ì˜: ì‹œí—˜ê³¼ ê´€ë ¨ëœ ëª¨ë“  ë°ì´í„°(ë¬¸í•­, ê²°ê³¼ ë“±)ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤.')">
                            <button type="submit" 
                                    style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; font-size: 12px; cursor: pointer;">
                              ì‚­ì œ
                            </button>
                          </form>
                        </div>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </form>
          {% else %}
            <p style="text-align: center; color: #666; padding: 20px;">ë“±ë¡ëœ ì‹œí—˜ì´ ì—†ìŠµë‹ˆë‹¤.</p>
          {% endif %}
        </div>
        
        <h2>ì‹œí—˜ë³„ í†µê³„</h2>
        <div style="position: relative; height: 400px;">
            <canvas id="examChart" width="600" height="300"></canvas>
        </div>
    </div>
    
    <script>
        const ctx = document.getElementById('examChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: {{ exam_labels|safe }},
                datasets: [{
                    label: 'í‰ê·  ì ìˆ˜',
                    data: {{ exam_averages|safe }},
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'blue',
                    borderWidth: 1
                }, {
                    label: 'ìµœê³  ì ìˆ˜',
                    data: {{ exam_maxes|safe }},
                    backgroundColor: 'rgba(255, 99, 132, 0.5)',
                    borderColor: 'red',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    </script>
    
    <script>
        // ì „ì²´ ì„ íƒ/í•´ì œ í† ê¸€
        function toggleAllCheckboxes() {
            const selectAllCheckbox = document.getElementById('selectAll');
            const examCheckboxes = document.querySelectorAll('.exam-checkbox');
            
            examCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            
            updateSelectedCount();
        }
        
        // ì„ íƒëœ ê°œìˆ˜ ì—…ë°ì´íŠ¸
        function updateSelectedCount() {
            const examCheckboxes = document.querySelectorAll('.exam-checkbox');
            const selectedCount = document.getElementById('selectedCount');
            const selectAllCheckbox = document.getElementById('selectAll');
            
            let checkedCount = 0;
            examCheckboxes.forEach(checkbox => {
                if (checkbox.checked) checkedCount++;
            });
            
            selectedCount.textContent = `ì„ íƒëœ ì‹œí—˜: ${checkedCount}ê°œ`;
            
            // ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì—…ë°ì´íŠ¸
            if (checkedCount === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else if (checkedCount === examCheckboxes.length) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            }
        }
        
        // ì¼ê´„ ì‚­ì œ í™•ì¸
        function confirmBulkDelete() {
            const examCheckboxes = document.querySelectorAll('.exam-checkbox:checked');
            
            if (examCheckboxes.length === 0) {
                alert('ì‚­ì œí•  ì‹œí—˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return false;
            }
            
            const count = examCheckboxes.length;
            const examNames = Array.from(examCheckboxes).map(checkbox => {
                const row = checkbox.closest('tr');
                return row.querySelector('td:nth-child(2) strong').textContent;
            }).join('\n- ');
            
            return confirm(`ì •ë§ë¡œ ë‹¤ìŒ ${count}ê°œì˜ ì‹œí—˜ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n- ${examNames}\n\nâš ï¸ ì£¼ì˜: ì‹œí—˜ê³¼ ê´€ë ¨ëœ ëª¨ë“  ë°ì´í„°(ë¬¸í•­, ê²°ê³¼ ë“±)ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤.`);
        }
    </script>
</body>
</html>
